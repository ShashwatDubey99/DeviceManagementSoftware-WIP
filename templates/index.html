<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Management</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

    <center><h2>Device Management</h2></center>
<center>
    <!-- Button to add a new device -->
    <button id="add-device-button" onclick="redirectToAddDevice()">+ Add Device</button>
    <img id="logo" src="/static/logo.png" alt="Logo">
    <!-- Filter by Class/Department dropdown -->
    <select id="filter-by-class" onchange="fetchDevices()">
        <option value="all">All</option>
        <option value="IT">IT</option>
        <option value="Science">Science</option>
        <option value="Math">Math</option>
        <option value="History">History</option>
        <option value="Class 1A">Class 1A</option>
                <option value="Class 1B">Class 1B</option>
                <option value="Class 2A">Class 2A</option>
                <option value="Class 2B">Class 2B</option>
                <option value="Class 3A">Class 3A</option>
                <option value="Class 3B">Class 3B</option>
                <option value="Class 4A">Class 4A</option>
                <option value="Class 4B">Class 4B</option>
                <option value="Class 5A">Class 5A</option>
                <option value="Class 5B">Class 5B</option>
                <option value="Class 6A">Class 6A</option>
                <option value="Class 6B">Class 6B</option>
                <option value="Class 7A">Class 7A</option>
                <option value="Class 7B">Class 7B</option>
                <option value="Class 8A">Class 8A</option>
                <option value="Class 8B">Class 8B</option>
                <option value="Class 9A">Class 9A</option>
                <option value="Class 9B">Class 9B</option>
                <option value="Class 10A">Class 10A</option>
                <option value="Class 10B">Class 10B</option>
                <option value="Class 11A">Class 11A</option>
                <option value="Class 11B">Class 11B</option>
                <option value="Class 12A">Class 12A</option>
                <option value="Class 12B">Class 12B</option>
        <!-- Add more class/department options as needed -->
    </select>
</center>

<!-- Device list table -->
<table id="device-table">
    <thead>
        <tr>
            <th>Description</th>
            <th>Date Of Purchase</th>
            <th>Class & Section</th>
            <th>Make</th>
            <th>Condition</th>
            <th>Condition Remark</th>
            <th>Serial No</th>
            <th>School Serial No</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="device-list">
        <!-- Devices will be dynamically inserted here -->
    </tbody>
</table>

<!-- Hidden Edit Device Form -->
<div id="edit-device-form" style="display:none;">
    <h3>Edit Device</h3>
    <form id="device-form" onsubmit="submitEditDevice(event)">
        <label for="edit-description">Description:</label>
        <input type="text" id="edit-description" name="description" required><br>
        
        <label for="edit-date">Date of Purchase:</label>
        <input type="date" id="edit-date" name="date" required><br>

        <label for="edit-class_section">Class/Department:</label>
        <select id="edit-class_section" name="class_section">
            <option value="IT">IT</option>
            <option value="Science">Science</option>
            <option value="Math">Math</option>
            <option value="History">History</option>
            <!-- Add more options as needed -->
        </select><br>

        <label for="edit-make">Make:</label>
        <input type="text" id="edit-make" name="make" required><br>

        <label for="edit-condition">Condition:</label>
        <input type="text" id="edit-condition" name="condition" required><br>

        <label for="edit-condition_remark">Condition Remark:</label>
        <input type="text" id="edit-condition_remark" name="condition_remark"><br>

        <label for="edit-serial_no">Serial Number:</label>
        <input type="text" id="edit-serial_no" name="serial_no" required><br>

        <label for="edit-school_serial_no">School Serial Number:</label>
        <input type="text" id="edit-school_serial_no" name="school_serial_no" required><br>

        <button type="submit">Save Changes</button>
    </form>
</div>
<footer id="footer">
    <p>Made By Shashwat Dubey with help hundreds of google searches and stackoverflow - <a href="https://github.com/ShashwatDubey99/DeviceManagementSoftware-WIP">GitHub</a> | <a href="/credits">Credits</a></p>
</footer>
<script>
// Password protection
const password = "1234";  // Define the password for deleting and editing devices

// Redirect to add device page
function redirectToAddDevice() {
    window.location.href = '/adddevice';
}

// Fetch and display devices
async function fetchDevices() {
    const selectedClass = document.getElementById('filter-by-class').value;
    let url = '/api/devices';

    if (selectedClass !== 'all') {
        url += `?class_section=${selectedClass}`;
    }

    const response = await fetch(url);
    const devices = await response.json();

    const deviceList = document.getElementById('device-list');
    deviceList.innerHTML = '';

    devices.forEach(device => {
        deviceList.innerHTML += `
            <tr>
                <td>${device.description}</td>
                <td>${device.date}</td>
                <td>${device.class_section}</td>
                <td>${device.make}</td>
                <td>${device.condition}</td>
                <td>${device.condition_remark}</td>
                <td>${device.serial_no}</td>
                <td>${device.school_serial_no}</td>
                <td>
                    <button onclick="deleteDevice(${device.id})">Delete</button>
                    <button onclick="showEditDeviceForm(${device.id})">Edit</button>
                </td>
            </tr>
        `;
    });
}

// Delete device with password confirmation
async function deleteDevice(id) {
    const userPassword = prompt("Enter password to delete this device:");
    if (userPassword !== password) {
        alert("Incorrect password");
        return;
    }

    const response = await fetch(`/api/devices/${id}`, { method: 'DELETE' });

    if (response.ok) {
        fetchDevices();
    } else {
        alert("Failed to delete device.");
    }
}

// Show the Edit Device form and pre-fill with existing data
async function showEditDeviceForm(id) {
    const userPassword = prompt("Enter password to edit this device:");
    if (userPassword !== password) {
        alert("Incorrect password");
        return;
    }

    const response = await fetch(`/api/devices/${id}`, { method: 'GET' });
    const device = await response.json();

    document.getElementById('edit-description').value = device.description;
    document.getElementById('edit-date').value = device.date;
    document.getElementById('edit-class_section').value = device.class_section;
    document.getElementById('edit-make').value = device.make;
    document.getElementById('edit-condition').value = device.condition;
    document.getElementById('edit-condition_remark').value = device.condition_remark;
    document.getElementById('edit-serial_no').value = device.serial_no;
    document.getElementById('edit-school_serial_no').value = device.school_serial_no;

    document.getElementById('edit-device-form').style.display = 'block';

    // Set the form submission for editing
    document.getElementById('device-form').onsubmit = function(event) {
        submitEditDevice(event, id);
    };
}

// Submit the edited device data
async function submitEditDevice(event, id) {
    event.preventDefault();

    const updatedData = {
        description: document.getElementById('edit-description').value,
        date: document.getElementById('edit-date').value,
        class_section: document.getElementById('edit-class_section').value,
        make: document.getElementById('edit-make').value,
        condition: document.getElementById('edit-condition').value,
        condition_remark: document.getElementById('edit-condition_remark').value,
        serial_no: document.getElementById('edit-serial_no').value,
        school_serial_no: document.getElementById('edit-school_serial_no').value
    };

    const response = await fetch(`/api/devices/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedData)
    });

    if (response.ok) {
        document.getElementById('edit-device-form').style.display = 'none';
        fetchDevices();
    } else {
        alert("Failed to update device.");
    }
}

// Fetch devices on page load
window.onload = fetchDevices;
</script>

</body>
</html>
